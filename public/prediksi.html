<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UMKM Profit/Loss Prediction</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-green: #3cb371;
            --primary-yellow: #ffd700;
            --light-green: #e6f7ef;
            --light-yellow: #fffacd;
        }

        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar {
            background-color: var(--primary-green);
        }

        .navbar-brand, .nav-link {
            color: white !important;
        }

        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            border: none;
        }

        .card-header {
            background-color: var(--primary-green);
            color: white;
            border-radius: 10px 10px 0 0 !important;
            padding: 15px 20px;
            font-weight: 600;
        }

        .btn-primary {
            background-color: var(--primary-green);
            border-color: var(--primary-green);
        }

        .btn-primary:hover {
            background-color: #2a9d5d;
            border-color: #2a9d5d;
        }

        .btn-secondary {
            background-color: var(--primary-yellow);
            border-color: var(--primary-yellow);
            color: #333;
        }

        .btn-secondary:hover {
            background-color: #e6c300;
            border-color: #e6c300;
            color: #333;
        }

        .form-control:focus {
            border-color: var(--primary-green);
            box-shadow: 0 0 0 0.25rem rgba(60, 179, 113, 0.25);
        }

        .result-card {
            background-color: var(--light-green);
        }

        .result-laba {
            color: var(--primary-green);
            font-weight: bold;
        }

        .result-rugi {
            color: #dc3545;
            font-weight: bold;
        }

        .table th {
            background-color: var(--primary-green);
            color: white;
        }

        .table-striped tbody tr:nth-of-type(odd) {
            background-color: var(--light-green);
        }

        .pagination .page-item.active .page-link {
            background-color: var(--primary-green);
            border-color: var(--primary-green);
        }

        .pagination .page-link {
            color: var(--primary-green);
        }

        .filter-section {
            background-color: var(--light-yellow);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .summary-card {
            background-color: var(--light-yellow);
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg mb-4">
        <div class="container">
            <a class="navbar-brand" href="#"><i class="bi bi-graph-up-arrow"></i> Myakuntan</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" id="nav-prediction">Prediction</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="nav-history">History</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Prediction Page -->
        <div id="prediction-page">
            <div class="row">
                <div class="col-md-8 mx-auto">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-calculator"></i> Prediksi Laba/Rugi UMKM
                        </div>
                        <div class="card-body">
                            <form id="prediction-form">
                                <div class="mb-3">
                                    <label for="user_id" class="form-label">User ID</label>
                                    <input type="text" class="form-control" id="user_id" required>
                                </div>
                                <div class="mb-3">
                                    <label for="bidang_usaha" class="form-label">Bidang Usaha</label>
                                    <select class="form-select" id="bidang_usaha" required>
                                        <option value="">Pilih Bidang Usaha</option>
                                        <option value="Jasa">Jasa</option>
                                        <option value="Perdagangan">Perdagangan</option>
                                        <option value="Manufaktur">Manufaktur</option>
                                    </select>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="tahun" class="form-label">Tahun</label>
                                        <input type="number" class="form-control" id="tahun" min="2020" max="2030" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="bulan" class="form-label">Bulan</label>
                                        <select class="form-select" id="bulan" required>
                                            <option value="">Pilih Bulan</option>
                                            <option value="1">Januari</option>
                                            <option value="2">Februari</option>
                                            <option value="3">Maret</option>
                                            <option value="4">April</option>
                                            <option value="5">Mei</option>
                                            <option value="6">Juni</option>
                                            <option value="7">Juli</option>
                                            <option value="8">Agustus</option>
                                            <option value="9">September</option>
                                            <option value="10">Oktober</option>
                                            <option value="11">November</option>
                                            <option value="12">Desember</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="pendapatan" class="form-label">Pendapatan (Rp)</label>
                                    <input type="number" class="form-control" id="pendapatan" min="0" required>
                                </div>
                                <div class="mb-3">
                                    <label for="beban_operasional" class="form-label">Beban Operasional (Rp)</label>
                                    <input type="number" class="form-control" id="beban_operasional" min="0" required>
                                </div>
                                <div class="mb-3">
                                    <label for="pajak" class="form-label">Pajak (Rp)</label>
                                    <input type="number" class="form-control" id="pajak" min="0" required>
                                </div>
                                <div class="mb-3">
                                    <label for="laba_rugi_lag" class="form-label">Laba/Rugi Bulan Sebelumnya (Rp)</label>
                                    <input type="number" class="form-control" id="laba_rugi_lag" required>
                                </div>
                                <div class="mb-3">
                                    <label for="model_type" class="form-label">Model Prediksi</label>
                                    <select class="form-select" id="model_type" required>
                                        <option value="regresi">Regresi</option>
                                        <option value="time_series">Time Series</option>
                                    </select>
                                </div>
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary"><i class="bi bi-lightning-charge"></i> Prediksi</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="card result-card d-none" id="result-container">
                        <div class="card-header">
                            <i class="bi bi-clipboard-data"></i> Hasil Prediksi
                        </div>
                        <div class="card-body text-center">
                            <h4>Hasil: <span id="hasil-prediksi"></span></h4>
                            <h5>Nilai Prediksi: Rp <span id="nilai-prediksi"></span></h5>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Page -->
        <div id="history-page" style="display: none;">
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card summary-card">
                        <div class="card-header">
                            <i class="bi bi-bar-chart"></i> Ringkasan
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-md-4">
                                    <h5>Total Prediksi</h5>
                                    <h3 id="total-data">0</h3>
                                </div>
                                <div class="col-md-4">
                                    <h5>Total Laba</h5>
                                    <h3 id="total-laba" class="result-laba">0</h3>
                                </div>
                                <div class="col-md-4">
                                    <h5>Total Rugi</h5>
                                    <h3 id="total-rugi" class="result-rugi">0</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="filter-section">
                        <h5><i class="bi bi-funnel"></i> Filter</h5>
                        <div class="row">
                            <div class="col-md-3 mb-2">
                                <label for="filter-tahun" class="form-label">Tahun</label>
                                <select class="form-select" id="filter-tahun">
                                    <option value="">Semua Tahun</option>
                                    <option value="2020">2020</option>
                                    <option value="2021">2021</option>
                                    <option value="2022">2022</option>
                                    <option value="2023">2023</option>
                                    <option value="2024">2024</option>
                                    <option value="2025">2025</option>

                                </select>
                            </div>
                            <div class="col-md-3 mb-2">
                                <label for="filter-bulan" class="form-label">Bulan</label>
                                <select class="form-select" id="filter-bulan">
                                    <option value="">Semua Bulan</option>
                                    <option value="1">Januari</option>
                                    <option value="2">Februari</option>
                                    <option value="3">Maret</option>
                                    <option value="4">April</option>
                                    <option value="5">Mei</option>
                                    <option value="6">Juni</option>
                                    <option value="7">Juli</option>
                                    <option value="8">Agustus</option>
                                    <option value="9">September</option>
                                    <option value="10">Oktober</option>
                                    <option value="11">November</option>
                                    <option value="12">Desember</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-2">
                                <label for="filter-user-id" class="form-label">User ID</label>
                                <input type="text" class="form-control" id="filter-user-id">
                            </div>
                            <div class="col-md-3 mb-2">
                                <label for="sort-by" class="form-label">Urutkan</label>
                                <select class="form-select" id="sort-by">
                                    <option value="timestamp,-1">Terbaru</option>
                                    <option value="timestamp,1">Terlama</option>
                                    <option value="nilai_prediksi,-1">Nilai Prediksi (Tertinggi)</option>
                                    <option value="nilai_prediksi,1">Nilai Prediksi (Terendah)</option>
                                </select>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between mt-3">
                            <button class="btn btn-primary" id="filter-button"><i class="bi bi-filter"></i> Terapkan Filter</button>
                            <button class="btn btn-secondary" id="export-button"><i class="bi bi-download"></i> Export Excel</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-clock-history"></i> Riwayat Prediksi
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>Tanggal</th>
                                            <th>User ID</th>
                                            <th>Bidang Usaha</th>
                                            <th>Periode</th>
                                            <th>Pendapatan</th>
                                            <th>Beban</th>
                                            <th>Pajak</th>
                                            <th>Model</th>
                                            <th>Hasil</th>
                                            <th>Nilai</th>
                                        </tr>
                                    </thead>
                                    <tbody id="history-table-body">
                                        <!-- Data will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                            <nav>
                                <ul class="pagination justify-content-center" id="pagination">
                                    <!-- Pagination will be loaded here -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let currentPage = 1;
        const itemsPerPage = 10;
        
        // DOM Elements
        const predictionPage = document.getElementById('prediction-page');
        const historyPage = document.getElementById('history-page');
        const navPrediction = document.getElementById('nav-prediction');
        const navHistory = document.getElementById('nav-history');
        const predictionForm = document.getElementById('prediction-form');
        const resultContainer = document.getElementById('result-container');
        const hasilPrediksi = document.getElementById('hasil-prediksi');
        const nilaiPrediksi = document.getElementById('nilai-prediksi');
        const filterButton = document.getElementById('filter-button');
        const exportButton = document.getElementById('export-button');
        
        // Navigation
        navPrediction.addEventListener('click', function(e) {
            e.preventDefault();
            predictionPage.style.display = 'block';
            historyPage.style.display = 'none';
            navPrediction.classList.add('active');
            navHistory.classList.remove('active');
        });
        
        navHistory.addEventListener('click', function(e) {
            e.preventDefault();
            predictionPage.style.display = 'none';
            historyPage.style.display = 'block';
            navPrediction.classList.remove('active');
            navHistory.classList.add('active');
            loadHistory();
        });
        
        // Form submission
        predictionForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const modelType = document.getElementById('model_type').value;
            const userId = document.getElementById('user_id').value;
            const bidangUsaha = document.getElementById('bidang_usaha').value;
            const tahun = parseInt(document.getElementById('tahun').value);
            const bulan = parseInt(document.getElementById('bulan').value);
            const pendapatan = parseFloat(document.getElementById('pendapatan').value);
            const bebanOperasional = parseFloat(document.getElementById('beban_operasional').value);
            const pajak = parseFloat(document.getElementById('pajak').value);
            const labaRugiLag = parseFloat(document.getElementById('laba_rugi_lag').value);
            
            const requestData = {
                model: modelType,
                fitur: {
                    User_ID: userId,
                    Bidang_Usaha: bidangUsaha,
                    Tahun: tahun,
                    Bulan: bulan,
                    Pendapatan: pendapatan,
                    Beban_Operasional: bebanOperasional,
                    Pajak: pajak,
                    Laba_Rugi_Lag: labaRugiLag
                }
            };
            
            // Show loading indicator
            const submitBtn = predictionForm.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
            submitBtn.disabled = true;
            
            // Make API request
            fetch('/predict', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                // Reset button
                submitBtn.innerHTML = originalBtnText;
                submitBtn.disabled = false;
                
                // Display result
                resultContainer.classList.remove('d-none');
                
                if (data.error) {
                    hasilPrediksi.textContent = "Error";
                    nilaiPrediksi.textContent = data.error;
                    resultContainer.classList.add('bg-danger-subtle');
                } else {
                    hasilPrediksi.textContent = data.hasil_prediksi;
                    nilaiPrediksi.textContent = new Intl.NumberFormat('id-ID').format(data.nilai_prediksi);
                    
                    if (data.hasil_prediksi === "Laba") {
                        hasilPrediksi.className = "result-laba";
                    } else {
                        hasilPrediksi.className = "result-rugi";
                    }
                }
                
                // Scroll to result
                resultContainer.scrollIntoView({ behavior: 'smooth' });
            })
            .catch(error => {
                // Reset button
                submitBtn.innerHTML = originalBtnText;
                submitBtn.disabled = false;
                
                // Display error
                resultContainer.classList.remove('d-none');
                hasilPrediksi.textContent = "Error";
                nilaiPrediksi.textContent = "Terjadi kesalahan pada server";
                console.error('Error:', error);
            });
        });
        
        // Load history data
        function loadHistory(page = 1) {
            currentPage = page;
            
            const tahun = document.getElementById('filter-tahun').value;
            const bulan = document.getElementById('filter-bulan').value;
            const userId = document.getElementById('filter-user-id').value;
            const sortOption = document.getElementById('sort-by').value.split(',');
            const sortBy = sortOption[0];
            const order = sortOption[1];
            
            let url = `/historylabarugis?page=${page}&limit=${itemsPerPage}`;
            
            if (tahun) url += `&tahun=${tahun}`;
            if (bulan) url += `&bulan=${bulan}`;
            if (userId) url += `&user_id=${userId}`;
            if (sortBy) url += `&sort_by=${sortBy}&order=${order}`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    // Update summary
                    document.getElementById('total-data').textContent = data.total_data;
                    document.getElementById('total-laba').textContent = data.total_laba;
                    document.getElementById('total-rugi').textContent = data.total_rugi;
                    
                    // Clear existing table data
                    const tableBody = document.getElementById('history-table-body');
                    tableBody.innerHTML = '';
                    
                    // Add table rows
                    data.laporan.forEach(item => {
                        const row = document.createElement('tr');
                        
                        // Format date
                        const date = new Date(item.timestamp);
                        const formattedDate = date.toLocaleDateString('id-ID', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        
                        // Format numbers
                        const formatCurrency = (value) => new Intl.NumberFormat('id-ID').format(value);
                        
                        // Create row content
                        row.innerHTML = `
                            <td>${formattedDate}</td>
                            <td>${item.User_ID}</td>
                            <td>${item.Bidang_Usaha}</td>
                            <td>${getBulanName(item.Bulan)} ${item.Tahun}</td>
                            <td>${formatCurrency(item.Pendapatan)}</td>
                            <td>${formatCurrency(item.Beban_Operasional)}</td>
                            <td>${formatCurrency(item.Pajak)}</td>
                            <td>${item.model === 'regresi' ? 'Regresi' : 'Time Series'}</td>
                            <td class="${item.hasil_prediksi === 'Laba' ? 'result-laba' : 'result-rugi'}">${item.hasil_prediksi}</td>
                            <td>${formatCurrency(item.nilai_prediksi)}</td>
                        `;
                        
                        tableBody.appendChild(row);
                    });
                    
                    // Build pagination
                    buildPagination(data.total_data, page, itemsPerPage);
                })
                .catch(error => {
                    console.error('Error loading history:', error);
                    document.getElementById('history-table-body').innerHTML = `
                        <tr><td colspan="10" class="text-center text-danger">Gagal memuat data</td></tr>
                    `;
                });
        }
        
        // Build pagination
        function buildPagination(totalItems, currentPage, itemsPerPage) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            
            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            const prevLink = document.createElement('a');
            prevLink.className = 'page-link';
            prevLink.href = '#';
            prevLink.innerHTML = '&laquo;';
            prevLink.addEventListener('click', function(e) {
                e.preventDefault();
                if (currentPage > 1) loadHistory(currentPage - 1);
            });
            prevLi.appendChild(prevLink);
            pagination.appendChild(prevLi);
            
            // Page numbers
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, currentPage + 2);
            
            if (endPage - startPage < 4 && totalPages > 5) {
                if (currentPage < 3) {
                    endPage = Math.min(5, totalPages);
                } else if (currentPage > totalPages - 2) {
                    startPage = Math.max(1, totalPages - 4);
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageLi = document.createElement('li');
                pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
                const pageLink = document.createElement('a');
                pageLink.className = 'page-link';
                pageLink.href = '#';
                pageLink.textContent = i;
                pageLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    loadHistory(i);
                });
                pageLi.appendChild(pageLink);
                pagination.appendChild(pageLi);
            }
            
            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            const nextLink = document.createElement('a');
            nextLink.className = 'page-link';
            nextLink.href = '#';
            nextLink.innerHTML = '&raquo;';
            nextLink.addEventListener('click', function(e) {
                e.preventDefault();
                if (currentPage < totalPages) loadHistory(currentPage + 1);
            });
            nextLi.appendChild(nextLink);
            pagination.appendChild(nextLi);
        }
        
        // Helper function to get month name
        function getBulanName(bulan) {
            const months = [
                'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
                'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'
            ];
            return months[bulan - 1];
        }
        
        // Filter button event
        filterButton.addEventListener('click', function() {
            loadHistory(1);
        });
        
        // Export button event
        exportButton.addEventListener('click', function() {
            const tahun = document.getElementById('filter-tahun').value;
            const bulan = document.getElementById('filter-bulan').value;
            const userId = document.getElementById('filter-user-id').value;
            
            let url = '/exportlaporan';
            const params = [];
            
            if (tahun) params.push(`tahun=${tahun}`);
            if (bulan) params.push(`bulan=${bulan}`);
            if (userId) params.push(`user_id=${userId}`);
            
            if (params.length > 0) {
                url += '?' + params.join('&');
            }
            
            // Create link for download
            const link = document.createElement('a');
            link.href = url;
            link.download = 'riwayat_prediksi.xlsx';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
        
        // Initialize with prediction page
        document.addEventListener('DOMContentLoaded', function() {
            // Set current year as default
            document.getElementById('tahun').value = new Date().getFullYear();
            
            // Set current month as default
            document.getElementById('bulan').value = new Date().getMonth() + 1;
        });
    </script>
</body>
</html>